<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FIKOS - Perekodan Inventory</title>
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #343a40;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #f4f6f8; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    .page { display: none; }
    .active-page { display: block; }

    /* Login */
    #loginPage {
      display: flex; justify-content: center; align-items: center; height: 100vh;
      background: var(--primary); color: white;
    }
    #loginForm {
      background: white; padding: 40px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      width: 320px; text-align: center;
    }
    #loginForm input {
      width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc;
      border-radius: 5px;
    }
    #loginForm button {
      width: 100%; padding: 10px; background: var(--primary); color: white;
      border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
    }

    /* Dashboard */
    header {
      text-align: center; margin-bottom: 20px;
    }
    header h1 { color: var(--primary); font-size: 2.2rem; }
    header p { color: #6c757d; margin-top: 5px; }

    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tabs button {
      flex: 1; padding: 12px; background: #e1e5ea; color: #333; font-weight: bold;
      border: none; border-radius: 5px 5px 0 0; cursor: pointer;
    }
    .tabs button.active { background: var(--primary); color: white; }
    .tabs button:hover:not(.active) { background: #0056b3; color: white; }

    .tab-content {
      background: white; padding: 20px; border-radius: 0 5px 5px 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;
    }

    .form-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px; margin-bottom: 15px;
    }
    input, select {
      padding: 8px; border: 1px solid #ccc; border-radius: 5px;
      width: 100%; box-sizing: border-box;
    }
    button.add { background: var(--success); color: white; }
    button.sell { background: var(--danger); color: white; }
    button.delete { background: #6c757d; color: white; }
    button:hover.add { background: #218838; }
    button:hover.sell { background: #c82333; }
    button:hover.delete { background: #5a6268; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: var(--primary); color: white; }
    tr:nth-child(even) { background: #f9f9f9; }

    .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .status-tinggi { background: #d4edda; color: #155724; }
    .status-sederhana { background: #fff3cd; color: #856404; }
    .status-rendah { background: #f8d7da; color: #721c24; }

    /* Stock Card Modal */
    #stockCardModal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none;
      justify-content: center; align-items: center; z-index: 1000;
    }
    #stockCard {
      background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px;
      max-height: 80vh; overflow-y: auto;
    }
    #stockCard h3 { margin-bottom: 15px; color: var(--primary); }
    #closeStockCard { margin-top: 15px; background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="active-page">
  <form id="loginForm">
    <h2>FIKOS Login</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container page">
  <header>
    <h1>Perekodan Inventory</h1>
    <p>Sistem Pengurusan Stok oleh FIKOS</p>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab1">Tambah Item / Kategori</button>
    <button class="tab-btn" data-tab="tab2">Rekod Jual</button>
    <button class="tab-btn" data-tab="tab3">Senarai Inventori</button>
    <button class="tab-btn" data-tab="tab4">Inventory Movement</button>
  </div>

  <!-- TAB 1: TAMBAH ITEM / KATEGORI -->
  <div id="tab1" class="tab-content">
    <h3>Tambah Kategori</h3>
    <div class="form-grid">
      <input type="text" id="new_category_name" placeholder="Nama Kategori" />
      <button id="addCategoryBtn" class="add">Tambah Kategori</button>
      <button id="deleteCategoryBtn" class="delete">Padam Kategori</button>
    </div>

    <h3>Tambah Item Baru</h3>
    <div class="form-grid">
      <select id="item_category"></select>
      <input type="text" id="item_sku" placeholder="Kod Item (auto jika kosong)" />
      <input type="text" id="item_name" placeholder="Nama Item" />
      <input type="number" id="item_qty" placeholder="Kuantiti" min="1" />
      <input type="text" id="item_location" placeholder="Lokasi Barang" />
      <input type="number" id="item_cost" placeholder="Harga Beli Seunit" min="0" step="0.01" />
      <input type="number" id="item_price" placeholder="Harga Jual Seunit" min="0" step="0.01" />
      <input type="number" id="item_min_stock" value="5" placeholder="Min Stok" min="0" />
      <button id="addItemBtn" class="add">Tambah Item</button>
      <button id="deleteItemBtn" class="delete">Padam Item</button>
    </div>
  </div>

  <!-- TAB 2: REKOD JUAL -->
  <div id="tab2" class="tab-content" style="display:none">
    <h3>Rekod Jual</h3>
    <div class="form-grid">
      <select id="trans_category"></select>
      <select id="trans_item"></select>
      <input type="number" id="trans_qty" placeholder="Kuantiti" min="1" />
      <button id="transBtn" class="sell">Jual</button>
    </div>
  </div>

  <!-- TAB 3: SENARAI INVENTORI -->
  <div id="tab3" class="tab-content" style="display:none">
    <h3>Senarai Inventori</h3>
    <table>
      <thead>
        <tr>
          <th>Kod Item</th>
          <th>Nama</th>
          <th>Kategori</th>
          <th>Kuantiti</th>
          <th>Lokasi</th>
          <th>Harga Beli</th>
          <th>Harga Jual</th>
          <th>Margin</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>
  </div>

  <!-- TAB 4: INVENTORY MOVEMENT -->
  <div id="tab4" class="tab-content" style="display:none">
    <h3>Inventory Movement</h3>
    <table>
      <thead>
        <tr>
          <th>Kod Item</th>
          <th>Tindakan</th>
          <th>Kuantiti</th>
          <th>Harga Seunit</th>
          <th>Tarikh</th>
        </tr>
      </thead>
      <tbody id="movementTable"></tbody>
    </table>
  </div>
</div>

<!-- STOCK CARD MODAL -->
<div id="stockCardModal">
  <div id="stockCard">
    <h3 id="stockCardTitle">Kad Stok: [Item]</h3>
    <p><strong>Baki Stok:</strong> <span id="stockQty"></span></p>
    <p><strong>Nilai Stok (RM):</strong> RM<span id="stockValue"></span></p>
    <p><strong>Lokasi:</strong> <span id="stockLocation"></span></p>
    <p><strong>Batch Masuk (FIFO):</strong></p>
    <div id="batchList"></div>
    <button id="closeStockCard">Tutup</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAIk6aEQJnuK4Vwn9gD3RZ2My6fi04DArM",
  authDomain: "inventory-app-ab414.firebaseapp.com",
  databaseURL: "https://inventory-app-ab414-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "inventory-app-ab414",
  storageBucket: "inventory-app-ab414.firebasestorage.app",
  messagingSenderId: "982818040940",
  appId: "1:982818040940:web:bb439dcac05bea3bf97c49"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const inventoryRef = db.ref('fikos/inventory');
const movementRef = db.ref('fikos/movement');
const categoriesRef = db.ref('fikos/categories');
const lastSKURef = db.ref('fikos/lastSKU');

// --- STATE ---
let categories = [];
let inventory = [];
let movement = [];
let lastSKU = {};

// --- AUTH ---
const loginForm = document.getElementById('loginForm');
loginForm.addEventListener('submit', e => {
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value;
  if (email === 'alip1234@gmail.com' && pass === 'alip1234') {
    document.getElementById('loginPage').classList.remove('active-page');
    document.getElementById('dashboard').classList.add('active-page');
    loadData();
  } else {
    alert('Email atau password salah!');
  }
});

// --- TABS ---
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).style.display = 'block';
  });
});

// --- LOAD DATA FROM FIREBASE ---
function loadData() {
  categoriesRef.on('value', snap => {
    categories = snap.val() || [];
    renderCategories();
  });
  inventoryRef.on('value', snap => {
    inventory = snap.val() || [];
    renderInventoryTable();
  });
  movementRef.on('value', snap => {
    movement = snap.val() || [];
    renderMovementTable();
  });
  db.ref('fikos/lastSKU').on('value', snap => {
    lastSKU = snap.val() || {};
  });
}

// --- SAVE TO FIREBASE ---
function saveData() {
  inventoryRef.set(inventory);
  movementRef.set(movement);
  categoriesRef.set(categories);
  db.ref('fikos/lastSKU').set(lastSKU);
}

// --- RENDER ---
function renderCategories() {
  const selects = ['item_category', 'trans_category'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">-- Pilih --</option>';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      sel.appendChild(opt);
    });
  });
  renderTransItemDropdown();
}

function renderTransItemDropdown() {
  const cat = document.getElementById('trans_category').value;
  const sel = document.getElementById('trans_item');
  sel.innerHTML = '<option value="">-- Pilih Item --</option>';
  inventory
    .filter(i => i.category === cat)
    .forEach(i => {
      const opt = document.createElement('option');
      opt.value = i.kodeItem;
      opt.textContent = `${i.kodeItem} - ${i.name}`;
      sel.appendChild(opt);
    });
}

document.getElementById('trans_category').addEventListener('change', renderTransItemDropdown);

// --- STATUS STOK ---
function getStatusClass(qty) {
  if (qty >= 10) return 'status-tinggi';
  if (qty >= 5) return 'status-sederhana';
  return 'status-rendah';
}
function getStatusText(qty) {
  if (qty >= 10) return 'Tinggi';
  if (qty >= 5) return 'Sederhana';
  return 'Rendah';
}

// --- RENDER TABLES ---
function renderInventoryTable() {
  const tbody = document.getElementById('inventoryTable');
  tbody.innerHTML = '';
  inventory.forEach(i => {
    const statusClass = getStatusClass(i.qty);
    const statusText = getStatusText(i.qty);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="#" onclick="showStockCard('${i.kodeItem}'); return false;">${i.kodeItem}</a></td>
      <td>${i.name}</td>
      <td>${i.category}</td>
      <td>${i.qty}</td>
      <td>${i.location}</td>
      <td>${parseFloat(i.cost).toFixed(2)}</td>
      <td>${parseFloat(i.price).toFixed(2)}</td>
      <td>${(i.price - i.cost).toFixed(2)}</td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

function renderMovementTable() {
  const tbody = document.getElementById('movementTable');
  tbody.innerHTML = '';
  movement.slice().reverse().forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${m.kodeItem}</td>
      <td>${m.action}</td>
      <td>${m.qty}</td>
      <td>${parseFloat(m.price).toFixed(2)}</td>
      <td>${m.date}</td>
    `;
    tbody.appendChild(tr);
  });
}

// --- STOCK CARD ---
function showStockCard(kodeItem) {
  const item = inventory.find(i => i.kodeItem === kodeItem);
  if (!item) return;

  document.getElementById('stockCardTitle').textContent = `Kad Stok: ${item.name}`;
  document.getElementById('stockQty').textContent = item.qty;
  document.getElementById('stockLocation').textContent = item.location || '-';

  // Nilai stok (jumlah semua batch)
  let totalValue = 0;
  if (item.batches && item.batches.length) {
    totalValue = item.batches.reduce((sum, b) => sum + (b.qty * b.cost), 0);
    const batchList = document.getElementById('batchList');
    batchList.innerHTML = '';
    item.batches.forEach(b => {
      const div = document.createElement('div');
      div.textContent = `${new Date(b.date).toLocaleString('ms-MY')} â€” ${b.qty} unit @ RM${b.cost.toFixed(2)} (${b.location || '-'})`;
      batchList.appendChild(div);
    });
  } else {
    totalValue = item.qty * item.cost;
    document.getElementById('batchList').innerHTML = '<em>Tiada data batch (versi lama)</em>';
  }

  document.getElementById('stockValue').textContent = totalValue.toFixed(2);
  document.getElementById('stockCardModal').style.display = 'flex';
}

document.getElementById('closeStockCard').addEventListener('click', () => {
  document.getElementById('stockCardModal').style.display = 'none';
});

// --- TAMBAH KATEGORI ---
document.getElementById('addCategoryBtn').addEventListener('click', () => {
  const cat = document.getElementById('new_category_name').value.trim();
  if (!cat) return alert('Nama kategori diperlukan');
  if (categories.includes(cat)) return alert('Kategori sudah wujud');
  categories.push(cat);
  lastSKU[cat] = 0;
  saveData();
  renderCategories();
  document.getElementById('new_category_name').value = '';
});

// --- PADAM KATEGORI ---
document.getElementById('deleteCategoryBtn').addEventListener('click', () => {
  const cat = document.getElementById('item_category').value;
  if (!cat) return alert('Pilih kategori');
  if (!confirm(`Padam kategori "${cat}" dan semua item di dalamnya?`)) return;
  
  inventory = inventory.filter(i => i.category !== cat);
  movement.push({
    kodeItem: '*',
    action: `Padam kategori: ${cat}`,
    qty: 0,
    price: 0,
    date: new Date().toLocaleString('ms-MY')
  });
  categories = categories.filter(c => c !== cat);
  delete lastSKU[cat];
  saveData();
});

// --- TAMBAH ITEM ---
document.getElementById('addItemBtn').addEventListener('click', () => {
  const cat = document.getElementById('item_category').value;
  let kodeItem = document.getElementById('item_sku').value.trim();
  const name = document.getElementById('item_name').value.trim();
  const qty = parseInt(document.getElementById('item_qty').value);
  const loc = document.getElementById('item_location').value.trim();
  const cost = parseFloat(document.getElementById('item_cost').value);
  const price = parseFloat(document.getElementById('item_price').value);
  const minStock = parseInt(document.getElementById('item_min_stock').value) || 5;

  if (!cat || !name || !qty || !cost || !price || qty <= 0 || cost < 0 || price < 0) {
    return alert('Sila lengkapkan semua medan dengan betul');
  }

  if (!kodeItem) {
    lastSKU[cat] = (lastSKU[cat] || 0) + 1;
    kodeItem = cat.substring(0, 3).toUpperCase() + '-' + String(lastSKU[cat]).padStart(3, '0');
  }

  if (inventory.some(i => i.kodeItem === kodeItem)) {
    return alert('Kod Item sudah wujud');
  }

  // Simpan dalam batch (untuk FIFO)
  const newItem = {
    kodeItem,
    name,
    category: cat,
    qty,
    location: loc,
    cost,
    price,
    minStock,
    batches: [{
      date: new Date().toISOString(),
      qty,
      cost,
      location: loc
    }]
  };

  inventory.push(newItem);
  movement.push({
    kodeItem,
    action: 'Masuk',
    qty,
    price: cost,
    date: new Date().toLocaleString('ms-MY')
  });

  saveData();
  alert(`Item ditambah: ${kodeItem}`);
  document.getElementById('item_sku').value = '';
  document.getElementById('item_name').value = '';
  document.getElementById('item_qty').value = '';
  document.getElementById('item_location').value = '';
  document.getElementById('item_cost').value = '';
  document.getElementById('item_price').value = '';
  document.getElementById('item_min_stock').value = '5';
});

// --- PADAM ITEM ---
document.getElementById('deleteItemBtn').addEventListener('click', () => {
  const kodeItem = document.getElementById('item_sku').value.trim();
  if (!kodeItem) return alert('Masukkan Kod Item untuk padam');
  if (!confirm(`Padam item "${kodeItem}"?`)) return;

  inventory = inventory.filter(i => i.kodeItem !== kodeItem);
  movement.push({
    kodeItem,
    action: 'Padam',
    qty: 0,
    price: 0,
    date: new Date().toLocaleString('ms-MY')
  });
  saveData();
});

// --- REKOD JUAL (FIFO) ---
document.getElementById('transBtn').addEventListener('click', () => {
  const kodeItem = document.getElementById('trans_item').value;
  const qty = parseInt(document.getElementById('trans_qty').value);
  if (!kodeItem || qty <= 0) return alert('Isi maklumat jualan');

  const item = inventory.find(i => i.kodeItem === kodeItem);
  if (!item) return alert('Item tidak dijumpai');
  if (qty > item.qty) return alert('Stok tidak mencukupi');

  // FIFO: kurangkan dari batch paling lama
  let remaining = qty;
  let totalCost = 0;
  if (item.batches && item.batches.length) {
    for (let i = 0; i < item.batches.length && remaining > 0; i++) {
      const batch = item.batches[i];
      if (batch.qty >= remaining) {
        totalCost += remaining * batch.cost;
        batch.qty -= remaining;
        remaining = 0;
      } else {
        totalCost += batch.qty * batch.cost;
        remaining -= batch.qty;
        item.batches.splice(i, 1);
        i--; // adjust index
      }
    }
  }

  item.qty -= qty;
  movement.push({
    kodeItem,
    action: 'Jual',
    qty,
    price: item.price,
    date: new Date().toLocaleString('ms-MY')
  });

  saveData();
  document.getElementById('trans_qty').value = '';
});

</script>
</body>
</html>
