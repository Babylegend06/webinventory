<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perekodan Inventory</title>
  <style>
    :root {
      --primary: #4361ee;
      --success: #4cc9f0;
      --danger: #f72585;
      --dark: #212529;
      --gray: #6c757d;
      --light: #f8f9fa;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      background-color: #f9fbfd;
      color: var(--dark);
    }
    /* PIN Modal */
    #auth-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999;
    }
    #auth-modal .card {
      background: white; padding: 2rem; border-radius: 12px; width: 300px; text-align: center;
    }
    #auth-modal input {
      width: 100%; padding: 0.75rem; margin: 1rem 0; border: 1px solid #ddd; border-radius: 6px; font-size: 1.1rem;
    }
    /* Header */
    header {
      background: white;
      padding: 1.2rem 2rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .logo-text h1 {
      font-size: 1.8rem; color: var(--primary); margin-bottom: 0.2rem;
    }
    .logo-text p {
      font-size: 0.95rem; color: var(--gray);
    }
    nav button {
      background: transparent; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600;
      cursor: pointer; margin: 0 0.3rem;
    }
    nav button:hover, nav button.active {
      background: #eef2ff; color: var(--primary);
    }
    main {
      padding: 2rem; max-width: 1000px; margin: 0 auto;
    }
    .page { display: none; }
    .page.active { display: block; }
    h2 {
      margin: 0 0 1.5rem 0; color: var(--primary);
    }
    .form-group {
      margin-bottom: 1.2rem;
    }
    label {
      display: block; margin-bottom: 0.4rem; font-weight: 600;
    }
    input, select {
      width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;
    }
    button[type="submit"] {
      background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem;
      border-radius: 6px; cursor: pointer; font-weight: bold;
    }
    table {
      width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 0.9rem; text-align: left; border-bottom: 1px solid #eee;
    }
    th { background: var(--primary); color: white; }
    tr:last-child td { border-bottom: none; }
    .btn-delete {
      background: var(--danger); color: white; border: none; padding: 0.3rem 0.6rem;
      border-radius: 4px; cursor: pointer; font-size: 0.85rem;
    }
    .log-entry {
      padding: 0.6rem 0; border-bottom: 1px dashed #eee; font-size: 0.95rem;
      color: var(--gray);
    }
    .summary-card {
      background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .summary-value {
      font-size: 1.8rem; font-weight: bold; color: var(--primary);
    }
    #status {
      position: fixed; top: 12px; right: 12px; padding: 0.5rem 1rem; background: var(--success);
      color: white; border-radius: 6px; z-index: 1000; display: none;
    }
    .batch-list {
      margin-top: 0.5rem; font-size: 0.9rem; color: #555;
    }
  </style>
</head>
<body>

<!-- üîí PIN Access Modal -->
<div id="auth-modal">
  <div class="card">
    <h3>Kata Laluan Akses</h3>
    <p>Masukkan PIN untuk masuk</p>
    <input type="password" id="pin-input" placeholder="Contoh: 1234" maxlength="4" />
    <button onclick="checkPIN()">Masuk</button>
  </div>
</div>

<div id="status">Menyambung ke Firebase...</div>

<header>
  <div class="logo-text">
    <h1>Perekodan Inventory</h1>
    <p>Sistem Pengurusan Stok oleh Aliff</p>
  </div>
  <nav>
    <button class="nav-btn active" data-page="dashboard">Dashboard</button>
    <button class="nav-btn" data-page="master">Master List</button>
    <button class="nav-btn" data-page="stockin">Stock In</button>
    <button class="nav-btn" data-page="stockout">Stock Out</button>
    <button class="nav-btn" data-page="log">Log</button>
  </nav>
</header>

<main>
  <!-- Dashboard -->
  <div id="dashboard" class="page active">
    <h2>üìä Dashboard</h2>
    <div class="summary-card">
      <p>Jumlah Jenis Item</p>
      <div class="summary-value" id="total-items">0</div>
    </div>
    <div class="summary-card">
      <p>Jumlah Unit Stok</p>
      <div class="summary-value" id="total-units">0</div>
    </div>
    <div class="summary-card">
      <p>Nilai Stok (RM)</p>
      <div class="summary-value" id="total-value">0.00</div>
    </div>
    <div class="summary-card">
      <p>Aktiviti Terkini</p>
      <div id="latest-activity">Menyambung...</div>
    </div>
  </div>

  <!-- Master List -->
  <div id="master" class="page">
    <h2>üìã Master List</h2>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Stok</th>
          <th>Lokasi</th>
          <th>Nilai (RM)</th>
          <th>Tindakan</th>
        </tr>
      </thead>
      <tbody id="item-table-body"></tbody>
    </table>
    <div id="stock-card-modal" style="display:none; margin-top:2rem; padding:1.5rem; background:white; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
      <h3 id="card-item-name">Kad Stok: [Nama]</h3>
      <p><strong>Baki Stok:</strong> <span id="card-qty"></span></p>
      <p><strong>Nilai Stok:</strong> RM<span id="card-value"></span></p>
      <p><strong>Lokasi:</strong> <span id="card-location"></span></p>
      <h4>Batch Masuk:</h4>
      <div id="card-batches"></div>
      <button onclick="closeStockCard()" style="margin-top:1rem;">Tutup</button>
    </div>
  </div>

  <!-- Stock In -->
  <div id="stockin" class="page">
    <h2>üì• Stock In</h2>
    <form id="form-in">
      <div class="form-group">
        <label>Nama Item</label>
        <input type="text" id="in-name" required placeholder="Laptop Dell" />
      </div>
      <div class="form-group">
        <label>Harga Seunit (RM)</label>
        <input type="number" step="0.01" id="in-price" required placeholder="2500.00" />
      </div>
      <div class="form-group">
        <label>Jumlah</label>
        <input type="number" id="in-qty" min="1" required placeholder="5" />
      </div>
      <div class="form-group">
        <label>Lokasi Simpanan</label>
        <input type="text" id="in-location" required placeholder="Gudang A, Rak 3" />
      </div>
      <button type="submit">Tambah Stok</button>
    </form>
  </div>

  <!-- Stock Out -->
  <div id="stockout" class="page">
    <h2>üì§ Stock Out</h2>
    <form id="form-out">
      <div class="form-group">
        <label>Nama Item</label>
        <input type="text" id="out-name" required placeholder="Laptop Dell" />
      </div>
      <div class="form-group">
        <label>Jumlah</label>
        <input type="number" id="out-qty" min="1" required placeholder="2" />
      </div>
      <button type="submit">Keluarkan Stok</button>
    </form>
  </div>

  <!-- Log -->
  <div id="log" class="page">
    <h2>üìú Inventory Movement Log</h2>
    <div id="log-entries"></div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIk6aEQJnuK4Vwn9gD3RZ2My6fi04DArM",
    authDomain: "inventory-app-ab414.firebaseapp.com",
    databaseURL: "https://inventory-app-ab414-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "inventory-app-ab414",
    storageBucket: "inventory-app-ab414.firebasestorage.app",
    messagingSenderId: "982818040940",
    appId: "1:982818040940:web:bb439dcac05bea3bf97c49"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const inventoryRef = ref(db, 'inventory');

  let inventory = {};
  let logs = [];
  const ACCESS_PIN = '1234'; // Tukar ikut kehendak anda

  function showStatus(msg, isError = false) {
    let status = document.getElementById('status');
    if (!status) {
      status = document.createElement('div');
      status.id = 'status';
      status.style.cssText = `
        position: fixed; top: 12px; right: 12px; padding: 0.5rem 1rem;
        background: ${isError ? '#f72585' : '#4cc9f0'}; color: white;
        border-radius: 6px; z-index: 1000;
      `;
      document.body.appendChild(status);
    }
    status.textContent = msg;
    status.style.display = 'block';
    setTimeout(() => status.style.display = 'none', 2000);
  }

  function saveData() {
    set(inventoryRef, { inventory, logs })
      .catch(err => console.error(err));
  }

  function addLog(type, item, qty, price = null, location = null) {
    const entry = {
      type,
      item,
      qty,
      price,
      location,
      date: new Date().toISOString()
    };
    logs.unshift(entry); // latest on top
    if (logs.length > 100) logs.pop(); // limit log
    saveData();
  }

  function deleteItem(itemName) {
    if (!confirm(`Hapus item "${itemName}" secara kekal?`)) return;
    delete inventory[itemName];
    addLog('DELETE', itemName, 0);
    renderAll();
  }

  function showStockCard(itemName) {
    const item = inventory[itemName];
    if (!item) return;

    // Hitung nilai stok
    let totalValue = 0;
    for (const batch of item.batches) {
      totalValue += batch.qty * batch.price;
    }

    // Dapatkan lokasi unik
    const locations = [...new Set(item.batches.map(b => b.location))].join(', ');

    document.getElementById('card-item-name').textContent = `Kad Stok: ${itemName}`;
    document.getElementById('card-qty').textContent = item.totalQty;
    document.getElementById('card-value').textContent = totalValue.toFixed(2);
    document.getElementById('card-location').textContent = locations;

    // Senarai batch
    const batchesDiv = document.getElementById('card-batches');
    batchesDiv.innerHTML = '';
    item.batches.forEach(b => {
      const div = document.createElement('div');
      div.className = 'batch-list';
      const date = new Date(b.date).toLocaleDateString('ms-MY');
      div.textContent = `${date} ‚Äî ${b.qty} unit @ RM${b.price.toFixed(2)} (${b.location})`;
      batchesDiv.appendChild(div);
    });

    document.getElementById('stock-card-modal').style.display = 'block';
  }

  function closeStockCard() {
    document.getElementById('stock-card-modal').style.display = 'none';
  }

  function renderAll() {
    renderDashboard();
    renderMasterList();
    renderLog();
  }

  function renderDashboard() {
    const totalItems = Object.keys(inventory).length;
    let totalUnits = 0, totalValue = 0;
    for (const item of Object.values(inventory)) {
      totalUnits += item.totalQty;
      for (const b of item.batches) {
        totalValue += b.qty * b.price;
      }
    }
    const latest = logs[0] ? 
      `[${new Date(logs[0].date).toLocaleString('ms-MY')}] ${logs[0].type === 'IN' ? 'üì•' : 'üì§'} ${logs[0].item} (${logs[0].qty})` 
      : "Tiada aktiviti";

    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('total-units').textContent = totalUnits;
    document.getElementById('total-value').textContent = totalValue.toFixed(2);
    document.getElementById('latest-activity').textContent = latest;
  }

  function renderMasterList() {
    const tbody = document.getElementById('item-table-body');
    tbody.innerHTML = '';
    for (const [name, item] of Object.entries(inventory)) {
      // Nilai stok
      let value = 0;
      for (const b of item.batches) value += b.qty * b.price;
      const locations = [...new Set(item.batches.map(b => b.location))].join(', ');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="#" onclick="showStockCard('${name}'); return false;">${name}</a></td>
        <td>${item.totalQty}</td>
        <td>${locations}</td>
        <td>RM${value.toFixed(2)}</td>
        <td><button class="btn-delete" onclick="deleteItem('${name}')">üóëÔ∏è</button></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderLog() {
    const logDiv = document.getElementById('log-entries');
    logDiv.innerHTML = '';
    logs.forEach(entry => {
      const date = new Date(entry.date).toLocaleString('ms-MY');
      let text = `[${date}] `;
      if (entry.type === 'IN') {
        text += `üì• Stock In: ${entry.item} ‚Äî ${entry.qty} unit @ RM${entry.price} (${entry.location})`;
      } else if (entry.type === 'OUT') {
        text += `üì§ Stock Out: ${entry.item} ‚Äî ${entry.qty} unit`;
      } else if (entry.type === 'DELETE') {
        text += `üóëÔ∏è Item dihapus: ${entry.item}`;
      }
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.textContent = text;
      logDiv.appendChild(div);
    });
  }

  // FIFO Logic for Stock Out
  function processStockOut(itemName, qtyToOut) {
    const item = inventory[itemName];
    if (!item || item.totalQty < qtyToOut) return false;

    let remaining = qtyToOut;
    let totalValueOut = 0;

    // Ambil dari batch paling lama (FIFO)
    for (let i = 0; i < item.batches.length && remaining > 0; i++) {
      const batch = item.batches[i];
      if (batch.qty >= remaining) {
        totalValueOut += remaining * batch.price;
        batch.qty -= remaining;
        remaining = 0;
        if (batch.qty === 0) item.batches.splice(i, 1);
      } else {
        totalValueOut += batch.qty * batch.price;
        remaining -= batch.qty;
        item.batches.splice(i, 1);
        i--; // adjust index after splice
      }
    }

    item.totalQty = (item.totalQty || 0) - qtyToOut;
    if (item.totalQty <= 0) delete inventory[itemName];
    return true;
  }

  // Navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      const page = btn.dataset.page;
      document.getElementById(page)?.classList.add('active');
      btn.classList.add('active');
    });
  });

  // PIN Access
  function checkPIN() {
    const pin = document.getElementById('pin-input').value;
    if (pin === ACCESS_PIN) {
      document.getElementById('auth-modal').style.display = 'none';
      showStatus('Selamat datang!');
    } else {
      alert('PIN salah!');
    }
  }
  document.getElementById('pin-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') checkPIN();
  });

  // Forms
  document.getElementById('form-in')?.addEventListener('submit', e => {
    e.preventDefault();
    const name = e.target.querySelector('#in-name').value.trim();
    const price = parseFloat(e.target.querySelector('#in-price').value);
    const qty = parseInt(e.target.querySelector('#in-qty').value);
    const location = e.target.querySelector('#in-location').value.trim();
    if (!name || !price || price <= 0 || !qty || qty <= 0 || !location) return;

    if (!inventory[name]) {
      inventory[name] = { totalQty: 0, batches: [] };
    }
    inventory[name].totalQty += qty;
    inventory[name].batches.push({
      date: new Date().toISOString(),
      qty,
      price,
      location
    });
    addLog('IN', name, qty, price, location);
    e.target.reset();
    renderAll();
  });

  document.getElementById('form-out')?.addEventListener('submit', e => {
    e.preventDefault();
    const name = e.target.querySelector('#out-name').value.trim();
    const qty = parseInt(e.target.querySelector('#out-qty').value);
    if (!name || !qty || qty <= 0) return;

    const success = processStockOut(name, qty);
    if (!success) {
      alert('Stok tidak mencukupi!');
      return;
    }
    addLog('OUT', name, qty);
    e.target.reset();
    renderAll();
  });

  // Load from Firebase
  onValue(inventoryRef, snapshot => {
    const data = snapshot.val();
    if (data) {
      inventory = data.inventory || {};
      logs = data.logs || [];
      renderAll();
      showStatus('‚úÖ Sambungan aktif', false);
    } else {
      inventory = {};
      logs = [];
      renderAll();
    }
  });
</script>

</body>
</html>
